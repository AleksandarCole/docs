  * [About Pipeline YAML](#pipeline-yaml-reference)
  * [Properties](#properties)
    * [version](#version)
    * [name](#name)
    * [agent](#agent)
      * [A Preface example](#a-preface-example)
  * [Blocks](#blocks)
     * [name](#name-in-blocks)
     * [task](#task-in-blocks)
  * [Task](#task)
     * [jobs](#jobs)
     * [agent in task](#agent-in-task)
     * [secrets](#secrets)
     * [prologue](#prologue)
     * [epilogue](#epilogue)
     * [env_vars](#env_vars)
       * [Example of task](#example-of-task)
       * [Example of task with agent](#example-of-task-with-agent)
  * [Jobs](#jobs)
     * [name](#name-in-jobs)
     * [commands](#commands)
       * [Examples of jobs](#example-of-jobs)
  * [Prologue and Epilogue](#prologue-and-epilogue)
     * [The prologue property](#the-prologue-property)
     * [Example of prologue](#example-of-prologue)
     * [The epilogue property](#the-epilogue-property)
     * [Example of epilogue](#example-of-epilogue)
  * [The secrets property](#the-secrets-property)
     * [name](#name-in-secrets)
     * [Example of secrets](#example-of-secrets)
  * [Complete examples](#complete-configuration-examples)
  * [The order of execution](#the-order-of-execution)
  * [Comments](#comments)
  * [See also](#see-also)


# Pipeline YAML Reference

This document is the reference for the YAML grammar used for describing the
pipelines of Semaphore 2.0.

The core properties of a Semaphore 2.0 pipeline configuration file are
`blocks`, which appear only once at the beginning of a YAML file, `task`,
which can appear multiple times and `jobs`, which can also be repeated.

Moreover, each Semaphore 2.0 pipeline configuration file has a preface, which
is mandatory and should be present on every `.semaphore/semaphore.yml` file you
create. The properties of the preface are `version`, `name`, which is the only
optional one and `agent`.

## Properties

## version

The `version` property is a string value that shows the version of the
pipeline YAML file that will be used.

List of valid values: `"v1.0"`

Example of `version` usage:

    version: "v1.0"

## name

The `name` property is a Unicode string that assigns a name to the Semaphore
2.0 project and is optional. However, you should always give a name to your
Semaphore 2.0 projects.

*Caution*: The `name` property can be found in other sections because it
is used for defining the name of a job inside a `jobs` block or the name of
a `task` section defined using `task`.

Example of `name` usage:

    name: "The name of the Semaphore 2.0 project"


## agent

The `agent` property requires one additional properties named `machine`, that
identifies the environment, that is the hardware of the Virtual machine and the
Operating System of the Virtual Machine, in which the jobs of the pipeline will
get executed.

Example of `agent` usage:

    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804


### machine

The `machine` property, which can only be found under `agent`, requires two
properties named `type` and `os_image`.

Example of `machine` usage:

    machine:
      type: e1-standard-2
      os_image: ubuntu1804


### type

The `type` property is intended for selecting the machine (hardware) you would
like to use for your builds.

List of valid values: `e1-standard-2`

Example of `type` usage:

    type: e1-standard-2

#### The e1-standard-2 constant

The `e1-standard-2` value used in the `type` property represents the hardware
of the Virtual Machine used for each job in the current pipeline and is a
global variable.


### os_image

The `os_image` property specifies the operating system and the version of the
operating system that will be used.

List of valid values: `ubuntu1804`

Example of `os_image` usage:

    os_image: ubuntu1804

#### The ubuntu1804 constant

The `ubuntu1804` value used in the `os_image` property represents the Operating
System of the Virtual Machine used for each job in the current pipeline and
is a global variable.


### A Preface example

    version: "v1.0"
    name: "The name of the Semaphore 2.0 project"
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
     - name: Inspect Linux environment
       task:
          jobs:
            - name: Print Envrinment variable
              commands:
                - echo $SEMAPHORE_PIPELINE_ID


## Blocks

The `blocks` property defines an array of `blocks` items that hold the
elements of a pipeline

The values of the `blocks` property are the `blocks` items of a pipeline.


### name in blocks

The `name` property is a Unicode string that assigns a name to a block and is
optional.

If you accidentally name two or more `blocks` items with the same name,
you will get an error message similar to the following:

> semaphore.yml ERROR:

> Error: "There are at least two blocks with same name: Build Go project"

Semaphore assigns its own unique names to nameless `blocks` items, which is
what is shown in the GUI.


### task in blocks

All the items of a `blocks` list have a `task` property that at the current
moment is required.

You will learn about the properties of a `task` item in a while.


### Example of Blocks

    version: "v1.0"
    name: "The name of the Semaphore 2.0 project"
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
     - name: Inspect Linux environment
       task:
          jobs:
            - name: Print Environment variables
              commands:
                - echo $SEMAPHORE_PIPELINE_ID
                - echo $HOME

## Task

The `task` keyword that comes after the `blocks` property divides a YAML
configuration file into major and distinct sections. Each `task` item can
have multiple `jobs` items, an optional `agent` section, an optional `prologue`
section, an optional `epilogue` section as well as an optional `env_vars` block
for defining environment variables and an optional `secrets` block for using
existing `secrets` environment variables.

### jobs

A `jobs` item is a property of `task` that allows you to define the commands
that you want to execute.

### agent in task

The `agent` section under a `task` section is optional. The properties and the
possible values of the `agent` section can be found in the
[agent reference](#agent).

### secrets

The `secrets` property is used for using existing `secrets` environment
variables.


### prologue

A `prologue` block is executed before the commands of each job of a `task`
item.

You can consider the `prologue` commands as part of each one of the `jobs` of
the same `task` item.


### epilogue

An `epilogue` block is executed after the commands of each `jobs` item of a
`task`.


### env_vars

The elements of an `env_vars` array are name and value pairs that hold the name
of the environment variable
and the value of the environment variable, respectively.


##### Example of env_vars

    version: "v1.0"
    name: A Semaphore 2.0 project
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
       task:
          jobs:
            - name: Check environment variables
              commands:
                - echo $HOME
                - echo $PI
                - echo $VAR1
          env_vars:
               - name: PI
                 value: "3.14159"
               - name: VAR1
                 value: This is Var 1

The preceding YAML code exempt defines two environment variables named `VAR1`
and `PI`. Both environment variables have string values, which means that
numeric values that are not natural numbers need to be included in double
quotes.


### Example of task

    version: "v1.0"
    name: "The name of the Semaphore 2.0 project"
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
       task:
          jobs:
            - name: Check environment variables
              commands:
                - echo $SEMAPHORE_PIPELINE_ID
                - echo $HOME
                - echo $PI
                - pwd
          prologue:
              commands:
                - checkout
          env_vars:
               - name: PI
                 value: "3.14159"

The indentation level of `prologue`, `epilogue`, `env_vars` and `jobs` properties should be the same.


### Example of task with agent

    version: "v1.0"
    name: YAML file example with task and agent.
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
     - name: Inspect Linux environment
       task:
          jobs:
            - name: Learn about SEMAPHORE_GIT_DIR
              commands:
                - echo $SEMAPHORE_GIT_DIR
    
     - name: Agent in task
       task:
          agent:
              machine:
                type: e1-standard-2
                os_image: ubuntu1804
          jobs:
            - name: Using agent job
              commands:
                - echo $PATH

## Jobs

The `jobs` items are essential for each pipeline because they
allow you to define the actual commands that you want to execute.

### name in jobs

The value of the optional `name` property is a Unicode string that provides a
name to a job.

Semaphore assigns its own names to nameless `jobs` items, which is what is
shown in the GUI.

Tip: It is considered a good practice to give descriptive names to the `jobs`
and the `blocks` items of a Semaphore 2.0 pipeline.


### commands

The `commands` property is an array of strings that holds the UNIX commands
that will be executed for a job.

### Example of jobs

The general structure of a job when using the `commands` property is as follows:

    version: "v1.0"
    name: "The name of the Semaphore 2.0 project"
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
       task:
          jobs:
            - name: Check environment variables
              commands:
                - echo $SEMAPHORE_PIPELINE_ID
                - pwd


## Prologue and Epilogue

A `.semaphore/semaphore.yml` configuration file can have a single `prologue`
and a single `epilogue` property per `task` property. Both `prologue` and
`epilogue` properties are optional.


### The prologue property

A `prologue` block in a `task` block is used when you want to execute some
commands prior to all the `jobs` of that `task`. This is usually the case
with initialization commands that install software, start or stop services,
etc.

Please notice that a project *will fail* if a command in the `prologue` fails to
execute for some reason.

### Example of prologue

      prologue:
          commands:
            - checkout

### The Epilogue property

An `epilogue` block should be used when you want to execute some commands
after a job has finished, either successfully or unsuccessfully.

Please notice that a project *will not fail* if one or more commands in the
`epilogue` fail to execute for some reason.

### Example of epilogue

      epilogue:
          commands:
            - echo $SEMAPHORE_JOB_RESULT
            - echo $SEMAPHORE_PIPELINE_ID

## The secrets property

A `secrets` bucket is a place when you define environment variables that you
do not want to make public in a `.semaphore/semaphore.yml` file or in a text
file that is stored in a GitHub repository. A `secrets` bucket is defined
using a different YAML grammar and the `sem` utility.

The `secrets` property is for using existing environment variables from an
existing `secrets` bucket.

Please notice that when the names of the environment variables of two
more more `secrets` are the same, then the environment variable will
have the value that can be found in the `secrets` property that was
imported last.

Additionally, if you try to use a `name` value that does not exist, the
pipeline will fail to compile and therefore run.


### name in secrets

The `name` property is compulsory is a `secrets` block because it
specifies the `secrets` bucket that you want to use. Please note
that the specified `secrets` bucket should be under the
active organization.


### Example of secrets

    version: "v1.0"
    name: Pipeline configuration with secrets
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
      - task:
          jobs:
            - name: Using secrets
              commands:
                - echo $USERNAME
                - echo $PASSWORD
          secrets:
            - name: mysql-secrets

Environment variable defined in a `secrets` property are used like regular
environment variables defined in a `env_vars` block.


## Complete Configuration examples


###  A complete .semaphore/semaphore.yml example

The following code presents a complete `.semaphore/semaphore.yml` file:

    version: "v1.0"
    name: YAML file example for Go project.
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    
    blocks:
     - name: Inspect Linux environment
       task:
          jobs:
            - name: Execute hw.go
              commands:
                - echo $SEMAPHORE_PIPELINE_ID
                - echo $HOME
                - echo $SEMAPHORE_GIT_DIR
                - echo $PI
          prologue:
              commands:
                - checkout
          env_vars:
               - name: PI
                 value: "3.14159"
    
     - name: Build Go project
       task:
          jobs:
            - name: Build hw.go
              commands:
                - checkout
                - sudo apt-get -y install golang-go
                - go build hw.go
                - ./hw
            - name: PATH variable
              commands:
                - echo $PATH
          epilogue:
              commands:
                - echo $SEMAPHORE_JOB_RESULT
                - echo $SEMAPHORE_PIPELINE_ID


### A .semaphore/semaphore.yml file that uses secrets

    version: "v1.0"
    name: Pipeline configuration with secrets
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
      - task:
          jobs:
            - name: Using secrets
              commands:
                - checkout
                - ls -l .semaphore
                - echo $SEMAPHORE_PIPELINE_ID
                - echo "Hello World!"
                - echo $SECRET_ONE
                - echo $SECRET_TWO
            - name: Using SECRET_TWO
              commands:
                - checkout
                - echo $SECRET_TWO
                - ls -l .semaphore
          secrets:
            - name: mySecrets
            - name: more-mihalis-secrets

### A .semaphore/semaphore.yml file without name properties

Although it is allowed to have `.semaphore/semaphore.yml` files without
name properties, it is considered a very bad practice and should be
avoided.

However, the following sample `.semaphore/semaphore.yml` file proves
that it can be done:

    version: "v1.0"
    name: Basic YAML configuration file example.
    agent:
      machine:
        type: e1-standard-2
        os_image: ubuntu1804
    blocks:
      - task:
          jobs:
              - commands:
                 - echo $SEMAPHORE_PIPELINE_ID
                 - echo "Hello World!"


## The order of execution

You cannot and you should not make any assumptions about the order the
various `jobs` of a `task` are going to be executed. This means that the
jobs of each `task` block might not start in the order of definition.

However, the `blocks` items of a `.semaphore/semaphore.yml` file, which
are `task`, are executed sequentially. This means that if you have
two `task` items on a `.semaphore/semaphore.yml` file, the second one will
begin only when the first one has finished.

Last, the jobs of a block will run in parallel provided that you have
the required capacity (boxes) available.

#### Comments

Lines that begin with `#` are considered comments and are being ignored by the
YALM parser, which is not a Semaphore 2.0 feature but the way YAML files work.

### See also

   * [Secrets YAML reference]
   * [Changing organizations]
